{% extends "index.html" %}
{% load planning_filters %}

{% block title %}
Gestion des Activités - {{ plan.titre }} - {{ annee }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-5 text-orange fw-bold animate-fade-in">{{ plan.titre }} - {{ entity }}<br><br>Gestion des Activités - {{ annee }}</h2>

    {% if messages %}
        <div class="mt-3 animate-fade-in">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if activites %}
        <div class="table-container shadow-lg rounded animate-slide-up" style="animation-delay: 0.2s;">
            <div class="scrollable-table">
                <table class="table table-bordered table-striped">
                    <thead class="bg-orange text-white">
                        <tr class="header-row-1">
                            <th rowspan="2">Référence</th>
                            <th rowspan="2">Titre</th>
                            <th rowspan="2">Type</th>
                            <th colspan="4">Indicateur</th>
                            <th colspan="4">Périodes d'exécution</th>
                            <th rowspan="2">État d'avancement</th>
                            <th rowspan="2">Coût {{ annee }}</th>
                            <th rowspan="2">Commentaire</th>
                            <th rowspan="2">Commentaire SE</th>
                            <th rowspan="2">Statut</th>
                            <th rowspan="2">Matrix Status</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr class="header-row-2">
                            <th>Libellé</th>
                            <th>Référence</th>
                            <th>Cible {{ annee }}</th>
                            <th>Réalisation {{ annee }}</th>
                            <th class="trimestre">T1</th>
                            <th class="trimestre">T2</th>
                            <th class="trimestre">T3</th>
                            <th class="trimestre">T4</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activite in activites %}
                            <tr data-id="{{ activite.id }}" data-has-responsable="{{ activite.has_responsable|lower }}" class="animate-slide-up" style="animation-delay: {{ forloop.counter0|mul:0.1 }}s;">
                                <td>{{ activite.reference }}</td>
                                <td>{{ activite.titre }}</td>
                                <td>{{ activite.type|default:'N/A' }}</td>
                                <td>{{ activite.indicateur_label|default:'N/A' }}</td>
                                <td>{{ activite.indicateur_reference|default:'N/A' }}</td>
                                <td>{{ activite.cible|default:'N/A' }}</td>
                                <td>
                                    <input type="text" class="form-control" name="realisation"
                                           value="{% if is_responsable %}{{ activite.resp_realisation }}{% else %}{{ activite.pf_realisation }}{% endif %}"
                                           data-model="{{ activite.model_realisation }}"
                                           data-pf="{{ activite.pf_realisation }}"
                                           data-resp="{{ activite.resp_realisation }}">
                                </td>
                                <td {% if activite.trimestres_suivi.0 %}class="bg-blue"{% endif %}></td>
                                <td {% if activite.trimestres_suivi.1 %}class="bg-blue"{% endif %}></td>
                                <td {% if activite.trimestres_suivi.2 %}class="bg-blue"{% endif %}></td>
                                <td {% if activite.trimestres_suivi.3 %}class="bg-blue"{% endif %}></td>
                                <td>
                                    <textarea class="form-control" name="etat_avancement"
                                              data-model="{{ activite.model_etat_avancement }}"
                                              data-pf="{{ activite.pf_etat_avancement }}"
                                              data-resp="{{ activite.resp_etat_avancement }}">{% if is_responsable %}{{ activite.resp_etat_avancement }}{% else %}{{ activite.pf_etat_avancement }}{% endif %}</textarea>
                                </td>
                                <td>{{ activite.cout }}</td>
                                <td>
                                    <textarea class="form-control" name="commentaire"
                                              data-model="{{ activite.model_commentaire }}"
                                              data-pf="{{ activite.pf_commentaire }}"
                                              data-resp="{{ activite.resp_commentaire }}">{% if is_responsable %}{{ activite.resp_commentaire }}{% else %}{{ activite.pf_commentaire }}{% endif %}</textarea>
                                </td>
                                <td>{{ activite.model_commentaire_se }}</td>
                                <td>{{ activite.model_status }}</td>
                                <td>{{ activite.model_matrix_status }}</td>
                                <td>
                                    <button class="btn btn-success action-btn"
                                            data-last-modified-by="{{ activite.last_modified_by }}"
                                            data-last-is-responsable="{{ activite.last_is_responsable|lower }}">✔</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5 animate-fade-in">
            <h3 class="text-warning fw-bold">Aucune activité pour {{ entity }} en {{ annee }} !</h3>
        </div>
    {% endif %}

    <div class="text-center mt-4 animate-fade-in">
        <a href="{% url 'pao_list' plan.id %}" class="btn btn-secondary btn-lg px-5 py-2 fw-bold">Retour</a>
    </div>

    <!-- Modale pour les points focaux sans responsable -->
    {% if is_point_focal and has_no_responsable %}
    <div class="modal fade" id="inviteResponsableModal" tabindex="-1" aria-labelledby="inviteResponsableModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-orange text-white">
                    <h5 class="modal-title fw-bold text-white" id="inviteResponsableModalLabel">Rappel Important</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-dark">Veuillez inviter votre responsable avant de pouvoir modifier vos activités.</p>
                    <p class="text-dark">Le suivi des activités de <strong>{{ entity }}</strong> requiert son implication.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const isResponsable = {{ is_responsable|lower }};
        const isPointFocal = {{ is_point_focal|lower }};
        const hasNoResponsable = {{ has_no_responsable|lower }};
    
        if (isPointFocal && hasNoResponsable) {
            const modal = new bootstrap.Modal(document.getElementById('inviteResponsableModal'), {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
        }
    
        function sendRequest(data, callback) {
            fetch('{% url "manage_activities" plan.id entity %}?annee={{ annee }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(callback)
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la soumission.');
            });
        }
    
        document.querySelectorAll('tr[data-id]').forEach(row => {
            const actionBtn = row.querySelector('.action-btn');
            const inputs = row.querySelectorAll('input[name="realisation"], textarea[name="etat_avancement"], textarea[name="commentaire"]');
            const activiteId = row.dataset.id;
            let lastModifiedBy = actionBtn.dataset.lastModifiedBy;
            let lastIsResponsable = actionBtn.dataset.lastIsResponsable === 'true';
            const hasResponsable = row.dataset.hasResponsable === 'true';
            let isSubmitted = false;
    
            function updateButtonState() {
                let matchesModel = true;
                let matchesLatest = true;
                let matchesPFProposed = true;  // Pour vérifier si les valeurs actuelles diffèrent de proposed_changes
    
                inputs.forEach(input => {
                    const modelValue = input.dataset.model || '';
                    const pfValue = input.dataset.pf || '';
                    const respValue = input.dataset.resp || '';
                    const currentValue = input.value;
    
                    if (currentValue !== modelValue) matchesModel = false;
                    if (isResponsable && currentValue !== respValue) matchesLatest = false;
                    if (isPointFocal && currentValue !== pfValue) {
                        matchesLatest = false;
                        matchesPFProposed = false;  // Les valeurs actuelles diffèrent de proposed_changes
                    }
                });
    
                if (isResponsable) {
                    if (isSubmitted && matchesLatest) {
                        actionBtn.textContent = '✔';
                        actionBtn.disabled = true;
                        actionBtn.classList.remove('btn-warning');
                        actionBtn.classList.add('btn-success');
                    } else {
                        actionBtn.textContent = 'Soumettre';
                        actionBtn.disabled = false;
                        actionBtn.classList.remove('btn-warning');
                        actionBtn.classList.add('btn-success');
                    }
                } else if (isPointFocal) {
                    if (!hasResponsable) {
                        actionBtn.textContent = 'Responsable requis';
                        actionBtn.disabled = true;
                        actionBtn.classList.remove('btn-success', 'btn-warning');
                        actionBtn.classList.add('btn-secondary');
                        inputs.forEach(input => {
                            input.disabled = true;
                            input.classList.add('bg-light');
                        });
                    } else if (isSubmitted && matchesLatest) {
                        actionBtn.textContent = '✔';
                        actionBtn.disabled = true;
                        actionBtn.classList.remove('btn-warning');
                        actionBtn.classList.add('btn-success');
                    } else if (!matchesPFProposed) {
                        actionBtn.textContent = 'Proposer';
                        actionBtn.disabled = false;
                        actionBtn.classList.remove('btn-success');
                        actionBtn.classList.add('btn-warning');
                    } else {
                        actionBtn.textContent = '✔';
                        actionBtn.disabled = true;
                        actionBtn.classList.remove('btn-warning');
                        actionBtn.classList.add('btn-success');
                    }
                }
            }
    
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    isSubmitted = false;
                    updateButtonState();
                });
                input.addEventListener('change', () => {
                    isSubmitted = false;
                    updateButtonState();
                });
            });
    
            updateButtonState();
    
            actionBtn.addEventListener('click', function () {
                if (!actionBtn.disabled) {
                    const formData = {
                        activite_id: activiteId,
                        etat_avancement: row.querySelector('[name="etat_avancement"]').value,
                        realisation: row.querySelector('[name="realisation"]').value,
                        commentaire: row.querySelector('[name="commentaire"]').value,
                    };
    
                    if (isResponsable && actionBtn.textContent === 'Soumettre') {
                        formData.submit = true;
                        sendRequest(formData, function(data) {
                            alert(data.message);
                            if (data.success) {
                                row.style.backgroundColor = '#e6ffe6';
                                inputs.forEach(input => {
                                    input.dataset.resp = input.value;
                                    input.dataset.pf = input.value;  // Synchro avec PF après soumission
                                });
                                lastModifiedBy = '{{ request.user.username }}';
                                lastIsResponsable = true;
                                actionBtn.dataset.lastModifiedBy = lastModifiedBy;
                                actionBtn.dataset.lastIsResponsable = 'true';
                                isSubmitted = true;
                                updateButtonState();
                            }
                        });
                    } else if (isPointFocal && actionBtn.textContent === 'Proposer') {
                        formData.propose = true;
                        sendRequest(formData, function(data) {
                            alert(data.message);
                            if (data.success) {
                                row.style.backgroundColor = '#fff3e6';
                                inputs.forEach(input => {
                                    input.dataset.pf = input.value;
                                    input.dataset.resp = input.value;  // Remplacer visuellement les valeurs Resp
                                });
                                lastModifiedBy = '{{ request.user.username }}';
                                lastIsResponsable = false;
                                actionBtn.dataset.lastModifiedBy = lastModifiedBy;
                                actionBtn.dataset.lastIsResponsable = 'false';
                                isSubmitted = true;
                                updateButtonState();
                            }
                        });
                    }
                }
            });
        });
    });
</script>
{% endblock %}

{% block style %}
<style>
    .text-orange { color: #ff6200 !important; }
    .bg-orange { background: #ff6200 !important; }
    .text-success { color: #28a745 !important; }
    .text-warning { color: #ffc107 !important; }
    .fw-bold { font-weight: bold; }
    .bg-blue { background-color: #cce5ff !important; }
    .table-container { 
        border-radius: 15px; 
        overflow: hidden; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        background: #fff; 
    }
    .scrollable-table {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        display: block;
    }
    .table { margin-bottom: 0; width: 100%; border-collapse: collapse; }
    .table th, .table td { vertical-align: middle; padding: 10px; min-width: 120px; }
    .table td { border: 1px solid #ff6200; }
    .table thead th {
        border: 1px solid black !important;
        text-align: center; 
        background: #ff6200; 
        color: white; 
        position: sticky;
        z-index: 10;
    }
    .header-row-1 th { top: 0; }
    .header-row-2 th { top: 40px; }
    .table th.trimestre, .table td:nth-child(8), .table td:nth-child(9), 
    .table td:nth-child(10), .table td:nth-child(11) { min-width: 50px; width: 50px; }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #fff3e6; }
    .form-control { min-width: 100px; }
    textarea.form-control { min-height: 80px; resize: vertical; }
    .btn-success { 
        background: #28a745; 
        color: white; 
        border: none; 
        border-radius: 25px; 
        padding: 6px 15px; 
        font-size: 1rem; 
        min-width: 120px; 
        text-align: center;
    }
    .btn-warning { 
        background: #ffc107; 
        color: black; 
        border: none; 
        border-radius: 25px; 
        padding: 6px 15px; 
        font-size: 1rem; 
        min-width: 120px; 
        text-align: center;
    }
    .btn-secondary { 
        background: #6c757d; 
        border: none; 
        border-radius: 25px; 
        padding: 10px 30px; 
        font-size: 1.25rem; 
    }
    .btn:hover:not(:disabled) { 
        opacity: 0.9; 
        transform: scale(1.05); 
        transition: all 0.3s ease; 
    }
    .btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
    }
    .animate-fade-in { 
        animation: fadeIn 1s ease-in-out forwards; 
    }
    .animate-slide-up { 
        animation: slideUp 0.8s ease-in-out forwards; 
    }
    @keyframes fadeIn { 
        from { opacity: 0; } 
        to { opacity: 1; } 
    }
    @keyframes slideUp { 
        from { opacity: 0; transform: translateY(20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    @media (max-width: 768px) {
        .scrollable-table { max-height: 300px; }
        .table th, .table td { min-width: 100px; }
        .table th.trimestre, .table td:nth-child(8), .table td:nth-child(9), 
        .table td:nth-child(10), .table td:nth-child(11) { min-width: 40px; width: 40px; }
        .header-row-2 th { top: 35px; }
    }
    .modal-content { 
        border-radius: 15px; 
        overflow: hidden; 
    }
    .modal-header.bg-orange { 
        border-bottom: none; 
    }
    .modal-body { 
        padding: 20px; 
        font-size: 1.1rem; 
    }
</style>
{% endblock %}