{% extends "index.html" %}
{% load planning_filters %}

{% block title %}
Gestion des Activités - {{ plan.titre }} - {{ annee }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-5 text-orange fw-bold animate-fade-in">{{ plan.titre }} - {{ entity }}<br><br>Gestion des Activités - {{ annee }}</h2>

    {% if messages %}
        <div class="mt-3 animate-fade-in">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if activites %}
        <div class="table-container shadow-lg rounded animate-slide-up" style="animation-delay: 0.2s;">
            <div class="scrollable-table">
                <table class="table table-bordered table-striped">
                    <thead class="bg-orange text-white">
                        <tr>
                            <th>Titre</th>
                            <th>Type</th>
                            <th>État d'avancement</th>
                            <th>Réalisation {{ annee }}</th>
                            <th>Coût {{ annee }}</th>
                            <th>Cible {{ annee }}</th>
                            <th>Commentaire</th>
                            <th>Commentaire SE</th>
                            <th>Statut</th>
                            <th>Matrix Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activite in activites %}
                            <tr data-id="{{ activite.id }}" class="animate-slide-up" style="animation-delay: {{ forloop.counter0|mul:0.1 }}s;">
                                <td>{{ activite.titre }}</td>
                                <td>{{ activite.type|default:'N/A' }}</td>
                                <td>
                                    <textarea class="form-control" name="etat_avancement">{{ activite.etat_avancement|default:'' }}</textarea>
                                </td>
                                <td>
                                    <input type="text" class="form-control" name="realisation" value="{{ activite.realisation|default:'' }}">
                                </td>
                                <td>{{ activite.cout|default:'0.0' }}</td>
                                <td>{{ activite.cible|default:'N/A' }}</td>
                                <td>
                                    <textarea class="form-control" name="commentaire">{{ activite.commentaire|default:'' }}</textarea>
                                </td>
                                <td>{{ activite.commentaire_se|default:'N/A' }}</td>
                                <td>{{ activite.status }}</td>
                                <td>{{ activite.matrix_status }}</td>
                                <td>
                                    {% if is_responsable or is_point_focal %}
                                        <button class="btn btn-primary save-btn">Enregistrer</button>
                                    {% endif %}
                                    {% if is_responsable %}
                                        <button class="btn btn-success validate-btn">Soumettre</button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5 animate-fade-in">
            <h3 class="text-warning fw-bold">Aucune activité pour {{ entity }} en {{ annee }} !</h3>
        </div>
    {% endif %}

    <div class="text-center mt-4 animate-fade-in">
        <a href="{% url 'pao_list' plan.id %}" class="btn btn-secondary btn-lg px-5 py-2 fw-bold">Retour</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    function sendRequest(data, callback) {
        fetch('{% url "manage_activities" plan.id entity %}?annee={{ annee }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(callback)
        .catch(error => console.error('Erreur:', error));
    }

    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const row = this.closest('tr');
            const activiteId = row.dataset.id;
            sendRequest({
                activite_id: activiteId,
                etat_avancement: row.querySelector('[name="etat_avancement"]').value,
                realisation: row.querySelector('[name="realisation"]').value,
                commentaire: row.querySelector('[name="commentaire"]').value,
                save: true
            }, data => {
                alert(data.message);
                if (data.success) {
                    row.querySelector('td:nth-child(9)').textContent = 'Draft';
                }
            });
        });
    });

    document.querySelectorAll('.validate-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const row = this.closest('tr');
            const activiteId = row.dataset.id;
            sendRequest({
                activite_id: activiteId,
                etat_avancement: row.querySelector('[name="etat_avancement"]').value,
                realisation: row.querySelector('[name="realisation"]').value,
                commentaire: row.querySelector('[name="commentaire"]').value,
                validate: true
            }, data => {
                alert(data.message);
                if (data.success) {
                    row.querySelector('td:nth-child(9)').textContent = 'Submitted_SE';
                }
            });
        });
    });
});
</script>
{% endblock %}

{% block style %}
<style>
    .text-orange { color: #ff6200 !important; }
    .bg-orange { background: #ff6200 !important; }
    .text-success { color: #28a745 !important; }
    .text-warning { color: #ffc107 !important; }
    .fw-bold { font-weight: bold; }

    .table-container { 
        border-radius: 15px; 
        overflow: hidden; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        background: #fff; 
    }
    .scrollable-table {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        display: block;
    }
    .table { 
        margin-bottom: 0; 
        width: 100%; 
        border-collapse: collapse; 
    }
    .table th, .table td { 
        vertical-align: middle; 
        border: 1px solid #ff6200; 
        padding: 10px; 
        min-width: 120px;
    }
    .table thead th { 
        text-align: center; 
        position: sticky; 
        top: 0; 
        z-index: 10;
        background: #ff6200; 
        color: white; 
    }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #fff3e6; }
    .form-control { min-width: 100px; }
    textarea.form-control { min-height: 80px; resize: vertical; }

    .btn-primary { background: #007bff; border: none; border-radius: 25px; padding: 6px 15px; }
    .btn-success { background: #28a745; color: white; border: none; border-radius: 25px; padding: 6px 15px; }
    .btn-secondary { background: #6c757d; border: none; border-radius: 25px; padding: 10px 30px; font-size: 1.25rem; }
    .btn:hover { opacity: 0.9; transform: scale(1.05); transition: all 0.3s ease; }

    .animate-fade-in { animation: fadeIn 1s ease-in-out forwards; }
    .animate-slide-up { animation: slideUp 0.8s ease-in-out forwards; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
        .scrollable-table { max-height: 300px; }
        .table th, .table td { min-width: 100px; }
    }
</style>
{% endblock %}