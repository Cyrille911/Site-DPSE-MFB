{% extends "index.html" %}
{% load planning_filters %}

{% block title %}
Gestion des Activités - {{ plan.titre }} - {{ annee }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-5 text-orange fw-bold animate-fade-in">{{ plan.titre }} - {{ entity }}<br><br>Gestion des Activités - {{ annee }}</h2>

    {% if messages %}
        <div class="mt-3 animate-fade-in">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if activites %}
        <div class="table-container shadow-lg rounded animate-slide-up" style="animation-delay: 0.2s;">
            <div class="scrollable-table">
                <table class="table table-bordered table-striped">
                    <thead class="bg-orange text-white">
                        <tr class="header-row-1">
                            <th rowspan="2">Référence</th>
                            <th rowspan="2">Titre</th>
                            <th rowspan="2">Type</th>
                            <th colspan="4">Indicateur</th>
                            <th colspan="4">Périodes d'exécution</th>
                            <th rowspan="2">État d'avancement</th>
                            <th rowspan="2">Coût {{ annee }}</th>
                            <th rowspan="2">Commentaire</th>
                            <th rowspan="2">Commentaire SE</th>
                            <th rowspan="2">Statut</th>
                            <th rowspan="2">Matrix Status</th>
                            <th rowspan="2">Actions</th>
                        </tr>
                        <tr class="header-row-2">
                            <th>Libellé</th>
                            <th>Référence</th>
                            <th>Cible {{ annee }}</th>
                            <th>Réalisation {{ annee }}</th>
                            <th class="trimestre">T1</th>
                            <th class="trimestre">T2</th>
                            <th class="trimestre">T3</th>
                            <th class="trimestre">T4</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activite in activites %}
                            <tr data-id="{{ activite.id }}" class="animate-slide-up" style="animation-delay: {{ forloop.counter0|mul:0.1 }}s;">
                                <td>{{ activite.reference }}</td>
                                <td>{{ activite.titre }}</td>
                                <td>{{ activite.type|default:'N/A' }}</td>
                                <td>{{ activite.indicateur_label|default:'N/A' }}</td>
                                <td>{{ activite.indicateur_reference|default:'N/A' }}</td>
                                <td>{{ activite.cible|default:'N/A' }}</td>
                                <td>
                                    <input type="text" class="form-control" name="realisation" value="{{ activite.realisation }}" data-pending="{{ activite.pending_realisation }}" data-initial="{{ activite.realisation }}">
                                </td>
                                <td {% if activite.trimestres_suivi.0 %}class="bg-blue"{% endif %}>T1</td>
                                <td {% if activite.trimestres_suivi.1 %}class="bg-blue"{% endif %}>T2</td>
                                <td {% if activite.trimestres_suivi.2 %}class="bg-blue"{% endif %}>T3</td>
                                <td {% if activite.trimestres_suivi.3 %}class="bg-blue"{% endif %}>T4</td>
                                <td>
                                    <textarea class="form-control" name="etat_avancement" data-pending="{{ activite.pending_etat_avancement }}" data-initial="{{ activite.etat_avancement }}">{{ activite.etat_avancement }}</textarea>
                                </td>
                                <td>{{ activite.cout }}</td>
                                <td>
                                    <textarea class="form-control" name="commentaire" data-pending="{{ activite.pending_commentaire }}" data-initial="{{ activite.commentaire }}">{{ activite.commentaire }}</textarea>
                                </td>
                                <td>{{ activite.commentaire_se }}</td>
                                <td>{{ activite.status }}</td>
                                <td>{{ activite.matrix_status|json_script:"matrix_status"|safe }}</td>
                                <td>
                                    <button class="btn btn-success submit-btn">✔</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="text-center py-5 animate-fade-in">
            <h3 class="text-warning fw-bold">Aucune activité pour {{ entity }} en {{ annee }} !</h3>
        </div>
    {% endif %}

    <div class="text-center mt-4 animate-fade-in">
        <a href="{% url 'pao_list' plan.id %}" class="btn btn-secondary btn-lg px-5 py-2 fw-bold">Retour</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    function sendRequest(data, callback) {
        fetch('{% url "manage_activities" plan.id entity %}?annee={{ annee }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(callback)
        .catch(error => console.error('Erreur:', error));
    }

    document.querySelectorAll('tr[data-id]').forEach(row => {
        const submitBtn = row.querySelector('.submit-btn');
        const inputs = row.querySelectorAll('input[name="realisation"], textarea[name="etat_avancement"], textarea[name="commentaire"]');
        const activiteId = row.dataset.id;

        function updateButtonState() {
            let hasChanges = false;
            inputs.forEach(input => {
                const pendingValue = input.dataset.pending || '';
                const initialValue = input.dataset.initial || '';
                const currentValue = input.value;

                if (pendingValue === '' && currentValue !== initialValue) {
                    hasChanges = true;
                } else if (pendingValue !== '' && currentValue !== pendingValue) {
                    hasChanges = true;
                }
            });
            submitBtn.textContent = hasChanges ? 'Soumettre' : '✔';
        }

        inputs.forEach(input => {
            input.addEventListener('input', updateButtonState);
            input.addEventListener('change', updateButtonState);
        });

        updateButtonState();

        submitBtn.addEventListener('click', function () {
            if (submitBtn.textContent === 'Soumettre') {
                const formData = {
                    activite_id: activiteId,
                    etat_avancement: row.querySelector('[name="etat_avancement"]').value,
                    realisation: row.querySelector('[name="realisation"]').value,
                    commentaire: row.querySelector('[name="commentaire"]').value,
                    submit: true
                };

                sendRequest(formData, function(data) {
                    alert(data.message);
                    if (data.success) {
                        row.style.backgroundColor = '#e6ffe6';
                        inputs.forEach(input => {
                            input.dataset.pending = input.value;
                        });
                        updateButtonState();
                    } else {
                        console.error('Erreur lors de la soumission:', data.message);
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}

{% block style %}
<style>
    .text-orange { color: #ff6200 !important; }
    .bg-orange { background: #ff6200 !important; }
    .text-success { color: #28a745 !important; }
    .text-warning { color: #ffc107 !important; }
    .fw-bold { font-weight: bold; }
    .bg-blue { background-color: #cce5ff !important; }

    .table-container { 
        border-radius: 15px; 
        overflow: hidden; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        background: #fff; 
    }
    .scrollable-table {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        display: block;
    }
    .table { 
        margin-bottom: 0; 
        width: 100%; 
        border-collapse: collapse; 
    }
    .table th, .table td { 
        vertical-align: middle; 
        padding: 10px; 
        min-width: 120px;
    }
    /* Bordures générales pour le corps du tableau (orange) */
    .table td {
        border: 1px solid #ff6200;
    }
    /* Bordures noires explicites pour l'en-tête */
    .table thead th {
        border: 1px solid black !important; /* Bordures noires pour l'en-tête */
        text-align: center; 
        background: #ff6200; 
        color: white; 
        position: sticky;
        z-index: 10;
    }
    .header-row-1 th {
        top: 0;
    }
    .header-row-2 th {
        top: 40px;
    }
    .table th.trimestre, .table td:nth-child(8), .table td:nth-child(9), 
    .table td:nth-child(10), .table td:nth-child(11) { 
        min-width: 50px;
        width: 50px;
    }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #fff3e6; }
    .form-control { min-width: 100px; }
    textarea.form-control { min-height: 80px; resize: vertical; }

    .btn-success { 
        background: #28a745; 
        color: white; 
        border: none; 
        border-radius: 25px; 
        padding: 6px 15px; 
        font-size: 1rem; 
        min-width: 80px; 
        text-align: center;
    }
    .btn-secondary { background: #6c757d; border: none; border-radius: 25px; padding: 10px 30px; font-size: 1.25rem; }
    .btn:hover { opacity: 0.9; transform: scale(1.05); transition: all 0.3s ease; }

    .animate-fade-in { animation: fadeIn 1s ease-in-out forwards; }
    .animate-slide-up { animation: slideUp 0.8s ease-in-out forwards; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
        .scrollable-table { max-height: 300px; }
        .table th, .table td { min-width: 100px; }
        .table th.trimestre, .table td:nth-child(8), .table td:nth-child(9), 
        .table td:nth-child(10), .table td:nth-child(11) { min-width: 40px; width: 40px; }
        .header-row-2 th { top: 35px; }
    }
</style>
{% endblock %}