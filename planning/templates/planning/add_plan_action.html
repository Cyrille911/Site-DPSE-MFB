{% extends 'index.html' %}

{% block title %}
Création d'un Plan d'Action
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <h1 class="text-center mb-4 text-primary fw-bold">Création d'un Plan d'Action</h1>

        <form action="{% url 'add_plan_action' %}" method="POST" id="add-plan-action">
            {% csrf_token %}
            <!-- 1. Informations sur le Plan d'Action -->
            <div class="card shadow-lg p-5 mb-5 bg-gradient rounded-4 border border-primary">
                <h3 class="text-primary mb-4">Informations sur le Plan d'Action</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="titre" class="form-label">Titre du Plan d'Action</label>
                        <input type="text" class="form-control shadow-sm border-primary" id="titre" name="titre" placeholder="Entrez le titre du plan" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="annee_depart" class="form-label">Année de Départ</label>
                        <input type="number" class="form-control shadow-sm border-primary" id="annee_depart" name="annee_depart" placeholder="Entrez l'année de départ" required min="2010">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="horizon" class="form-label">Horizon</label>
                        <input type="number" class="form-control shadow-sm border-primary" id="horizon" name="horizon" placeholder="En nombre d'années" required min="1">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="impact" class="form-label">Impact</label>
                    <textarea class="form-control shadow-sm border-primary" id="impact" name="impact" rows="3" placeholder="Impact du plan" required></textarea>
                </div>  

                <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-outline-warning me-3 shadow-sm" onclick="ajouterEffet()">Ajouter un effet</button>
                    <button type="submit" class="btn btn-success shadow-sm">Créer le plan d'action</button>
                </div>
            </div>

            <!-- Zone des effets -->
            <div id="effets" class="mb-4"></div>
        </form>
    </div>

    <style>
        /* Style pour les textarea des cibles */
        .cible-textarea {
            transition: height 0.4s ease-in-out, padding 0.4s ease-in-out; /* Transition douce pour la hauteur et le padding */
            height: 38px; /* Hauteur initiale similaire à un input */
            min-height: 38px; /* Hauteur minimale */
            resize: vertical; /* Permettre le redimensionnement manuel vertical */
            overflow: hidden; /* Masquer la barre de défilement par défaut */
            padding: 6px 12px; /* Padding initial similaire à un input */
        }
        .cible-textarea:focus {
            height: auto; /* Permettre l'expansion */
            padding: 10px 12px; /* Légère augmentation du padding pour un effet élégant */
        }
    </style>

    <script>
        // Gestion des compteurs
        let effetCount = 0;
        let produitCounts = {};
        let actionCounts = {};
        let activiteCounts = {};
        
        // Met à jour les compteurs dans l'interface utilisateur
        function mettreAJourStatistiques() {
            if (document.getElementById('effet_count')) {
                document.getElementById('effet_count').innerText = effetCount;
                document.getElementById('produit_count').innerText = Object.values(produitCounts).reduce((a, b) => a + b, 0);
                document.getElementById('action_count').innerText = Object.values(actionCounts).reduce((a, b) => a + b, 0);
                document.getElementById('activite_count').innerText = Object.values(activiteCounts).reduce((a, b) => a + b, 0);
            }
        }

        // Ajouter un effet
        function ajouterEffet() {
            effetCount++;
            const effetNum = effetCount;
            produitCounts[`${effetNum}`] = 0;

            const effetContainer = document.createElement('div');
            effetContainer.className = 'card shadow-lg p-4 mb-4 border border-success rounded-3 bg-light';
            effetContainer.id = `effet_${effetNum}`;
            effetContainer.innerHTML = ` 
                <h4 class="text-success" id="effet_id_${effetNum}">Effet ${effetNum}</h4>
                <div class="mb-3">
                    <label for="effet_titre_${effetNum}" class="form-label" id="effet_label_${effetNum}">Intitulé de l'effet ${effetNum}</label>
                    <input type="text" class="form-control shadow-sm border-success" id="effet_titre_${effetNum}" name="effet_titre_${effetNum}" required>
                </div>
                <div id="produits_effet_${effetNum}" class="ps-4"></div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-success me-2 shadow-sm" id="ajouter_produit_${effetNum}" onclick="ajouterProduit('${effetNum}')">Ajouter un produit</button>
                    <button type="button" class="btn btn-outline-danger shadow-sm" id="supprimer_effet_${effetNum}" onclick="supprimerEffet('${effetNum}')">Supprimer l'effet</button>
                </div>
            `;
            document.getElementById('effets').appendChild(effetContainer);
            mettreAJourStatistiques();
        }

        // Supprimer un effet
        function supprimerEffet(effetNum) {
            const confirmation = confirm(`Êtes-vous sûr de vouloir supprimer l'effet ${effetNum} ?`);
            effetNum = Number(effetNum);

            if (confirmation) {
                const effet = document.getElementById(`effet_${effetNum}`);
                effet.parentNode.removeChild(effet);

                for (let i = effetNum + 1; i <= effetCount; i++) {
                    document.getElementById(`effet_${i}`).id = `effet_${i - 1}`;
                    document.getElementById(`effet_id_${i}`).id = `effet_id_${i - 1}`;
                    document.getElementById(`effet_id_${i - 1}`).textContent = `Effet ${i - 1}`;
                    document.getElementById(`effet_label_${i}`).id = `effet_label_${i - 1}`;
                    document.getElementById(`effet_label_${i - 1}`).textContent = `Intitulé de l'effet ${i - 1}`;
                    document.getElementById(`effet_titre_${i}`).id = `effet_titre_${i - 1}`;
                    document.getElementById(`effet_titre_${i - 1}`).name = `effet_titre_${i - 1}`;
                    document.getElementById(`produits_effet_${i}`).id = `produits_effet_${i - 1}`;
                    document.getElementById(`ajouter_produit_${i}`).id = `ajouter_produit_${i - 1}`;
                    document.getElementById(`ajouter_produit_${i - 1}`).setAttribute('onclick', `ajouterProduit(${i - 1})`);
                    document.getElementById(`supprimer_effet_${i}`).id = `supprimer_effet_${i - 1}`;
                    document.getElementById(`supprimer_effet_${i - 1}`).setAttribute('onclick', `supprimerEffet(${i - 1})`);
                    produitCounts[`${i - 1}`] = produitCounts[`${i}`];
                    
                    for (let j = 1; j <= produitCounts[`${i}`]; j++) { 
                        document.getElementById(`produit_${i}.${j}`).id = `produit_${i-1}.${j}`;
                        document.getElementById(`produit_id_${i}.${j}`).id = `produit_id_${i-1}.${j}`;
                        document.getElementById(`produit_id_${i-1}.${j}`).textContent = `Produit ${i-1}.${j}`;
                        document.getElementById(`produit_label_${i}.${j}`).id = `produit_label_${i-1}.${j}`;
                        document.getElementById(`produit_label_${i-1}.${j}`).textContent = `Intitulé du produit ${i-1}.${j}`;
                        document.getElementById(`produit_titre_${i}.${j}`).id = `produit_titre_${i-1}.${j}`;
                        document.getElementById(`produit_titre_${i-1}.${j}`).name = `produit_titre_${i-1}.${j}`;
                        document.getElementById(`actions_produit_${i}.${j}`).id = `actions_produit_${i-1}.${j}`;
                        document.getElementById(`ajouter_action_${i}.${j}`).id = `ajouter_action_${i-1}.${j}`;
                        document.getElementById(`ajouter_action_${i-1}.${j}`).setAttribute('onclick', `ajouterAction(${i-1}, ${j})`);
                        document.getElementById(`supprimer_produit_${i}.${j}`).id = `supprimer_produit_${i-1}.${j}`;
                        document.getElementById(`supprimer_produit_${i-1}.${j}`).setAttribute('onclick', `supprimerProduit(${i-1}, ${j})`);
                        
                        for (let k = 1; k <= actionCounts[`${i}.${j}`]; k++) {
                            document.getElementById(`action_${i}.${j}.${k}`).id = `action_${i-1}.${j}.${k}`;
                            document.getElementById(`action_id_${i}.${j}.${k}`).id = `action_id_${i-1}.${j}.${k}`;
                            document.getElementById(`action_id_${i-1}.${j}.${k}`).textContent = `Action ${i-1}.${j}.${k}`;
                            document.getElementById(`action_label_${i}.${j}.${k}`).id = `action_label_${i-1}.${j}.${k}`;
                            document.getElementById(`action_label_${i-1}.${j}.${k}`).textContent = `Intitulé de l'action ${i-1}.${j}.${k}`;
                            document.getElementById(`action_titre_${i}.${j}.${k}`).id = `action_titre_${i-1}.${j}.${k}`;
                            document.getElementById(`action_titre_${i-1}.${j}.${k}`).name = `action_titre_${i-1}.${j}.${k}`;
                            document.getElementById(`activites_action_${i}.${j}.${k}`).id = `activites_action_${i-1}.${j}.${k}`;
                            document.getElementById(`ajouter_activite_${i}.${j}.${k}`).id = `ajouter_activite_${i-1}.${j}.${k}`;
                            document.getElementById(`ajouter_activite_${i-1}.${j}.${k}`).setAttribute('onclick', `ajouterActivite(${i-1}, ${j}, ${k})`);
                            document.getElementById(`supprimer_action_${i}.${j}.${k}`).id = `supprimer_action_${i-1}.${j}.${k}`;
                            document.getElementById(`supprimer_action_${i-1}.${j}.${k}`).setAttribute('onclick', `supprimerAction(${i-1}, ${j}, ${k})`);
                            
                            for (let l = 1; l <= activiteCounts[`${i}.${j}.${k}`]; l++) {
                                document.getElementById(`activite_${i}.${j}.${k}.${l}`).id = `activite_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_id_${i}.${j}.${k}.${l}`).id = `activite_id_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_id_${i-1}.${j}.${k}.${l}`).textContent = `Activité ${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_label_${i}.${j}.${k}.${l}`).id = `activite_label_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_label_${i-1}.${j}.${k}.${l}`).textContent = `Intitulé de l'activité ${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_titre_${i}.${j}.${k}.${l}`).id = `activite_titre_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`activite_titre_${i-1}.${j}.${k}.${l}`).name = `activite_titre_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`supprimer_activite_${i}.${j}.${k}.${l}`).id = `supprimer_activite_${i-1}.${j}.${k}.${l}`;
                                document.getElementById(`supprimer_activite_${i-1}.${j}.${k}.${l}`).setAttribute('onclick', `supprimerActivite(${i-1}, ${j}, ${k}, ${l})`);
                                document.getElementById(`cibles_periodes_couts_${i}.${j}.${k}.${l}`).id = `cibles_periodes_couts_${i-1}.${j}.${k}.${l}`;
                            }
                        }
                    }
                }

                effetCount--;
                delete produitCounts[`${effetNum}`];
                for (let j = effetNum; j < effetCount; j++) {
                    produitCounts[`${j}`] = produitCounts[`${j+1}`] || 0;
                    delete produitCounts[`${j+1}`];
                    for (let k = 1; k <= produitCounts[`${j}`]; k++) {
                        actionCounts[`${j}.${k}`] = actionCounts[`${j+1}.${k}`] || 0;
                        delete actionCounts[`${j+1}.${k}`];
                        for (let l = 1; l <= actionCounts[`${j}.${k}`]; l++) {
                            activiteCounts[`${j}.${k}.${l}`] = activiteCounts[`${j+1}.${k}.${l}`] || 0;
                            delete activiteCounts[`${j+1}.${k}.${l}`];
                        }
                    }
                }
                mettreAJourStatistiques();
            }
        }

        // Ajouter un produit
        function ajouterProduit(effetNum) {
            produitCounts[`${effetNum}`]++;
            const produitNum = produitCounts[`${effetNum}`];
            actionCounts[`${effetNum}.${produitNum}`] = 0;

            const produitContainer = document.createElement('div');
            produitContainer.className = 'card shadow-lg p-4 mb-4 border border-warning rounded-3 bg-light';
            produitContainer.id = `produit_${effetNum}.${produitNum}`;
            produitContainer.innerHTML = `
                <h5 class="text-warning" id="produit_id_${effetNum}.${produitNum}">Produit ${effetNum}.${produitNum}</h5>
                <div class="mb-3">
                    <label for="produit_titre_${effetNum}.${produitNum}" class="form-label" id="produit_label_${effetNum}.${produitNum}">Intitulé du produit ${effetNum}.${produitNum}</label>
                    <input type="text" class="form-control shadow-sm border-warning" id="produit_titre_${effetNum}.${produitNum}" name="produit_titre_${effetNum}.${produitNum}" required>
                </div>
                <div id="actions_produit_${effetNum}.${produitNum}" class="ps-4"></div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-info me-2 shadow-sm" id="ajouter_action_${effetNum}.${produitNum}" onclick="ajouterAction(${effetNum}, ${produitNum})">Ajouter une action</button>
                    <button type="button" class="btn btn-outline-danger shadow-sm" id="supprimer_produit_${effetNum}.${produitNum}" onclick="supprimerProduit(${effetNum}, ${produitNum})">Supprimer le produit</button>
                </div>
            `;
            document.getElementById(`produits_effet_${effetNum}`).appendChild(produitContainer);
            mettreAJourStatistiques();
        }

        // Supprimer un produit
        function supprimerProduit(effetNum, produitNum) {
            const confirmation = confirm(`Êtes-vous sûr de vouloir supprimer le produit ${effetNum}.${produitNum} ?`);
            effetNum = Number(effetNum);
            produitNum = Number(produitNum);

            if (confirmation) {
                const produit = document.getElementById(`produit_${effetNum}.${produitNum}`);
                produit.parentNode.removeChild(produit);

                for (let j = produitNum + 1; j <= produitCounts[`${effetNum}`]; j++) { 
                    document.getElementById(`produit_${effetNum}.${j}`).id = `produit_${effetNum}.${j - 1}`;
                    document.getElementById(`produit_id_${effetNum}.${j}`).id = `produit_id_${effetNum}.${j - 1}`;
                    document.getElementById(`produit_id_${effetNum}.${j - 1}`).textContent = `Produit ${effetNum}.${j - 1}`;
                    document.getElementById(`produit_label_${effetNum}.${j}`).id = `produit_label_${effetNum}.${j - 1}`;
                    document.getElementById(`produit_label_${effetNum}.${j - 1}`).textContent = `Intitulé du produit ${effetNum}.${j - 1}`;
                    document.getElementById(`produit_titre_${effetNum}.${j}`).id = `produit_titre_${effetNum}.${j - 1}`;
                    document.getElementById(`produit_titre_${effetNum}.${j - 1}`).name = `produit_titre_${effetNum}.${j - 1}`;
                    document.getElementById(`actions_produit_${effetNum}.${j}`).id = `actions_produit_${effetNum}.${j - 1}`;
                    document.getElementById(`ajouter_action_${effetNum}.${j}`).id = `ajouter_action_${effetNum}.${j - 1}`;
                    document.getElementById(`ajouter_action_${effetNum}.${j - 1}`).setAttribute('onclick', `ajouterAction(${effetNum}, ${j - 1})`);
                    document.getElementById(`supprimer_produit_${effetNum}.${j}`).id = `supprimer_produit_${effetNum}.${j - 1}`;
                    document.getElementById(`supprimer_produit_${effetNum}.${j - 1}`).setAttribute('onclick', `supprimerProduit(${effetNum}, ${j - 1})`);
                    
                    for (let k = 1; k <= actionCounts[`${effetNum}.${j}`]; k++) {
                        document.getElementById(`action_${effetNum}.${j}.${k}`).id = `action_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_id_${effetNum}.${j}.${k}`).id = `action_id_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_id_${effetNum}.${j-1}.${k}`).textContent = `Action ${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_label_${effetNum}.${j}.${k}`).id = `action_label_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_label_${effetNum}.${j-1}.${k}`).textContent = `Intitulé de l'action ${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_titre_${effetNum}.${j}.${k}`).id = `action_titre_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`action_titre_${effetNum}.${j-1}.${k}`).name = `action_titre_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`activites_action_${effetNum}.${j}.${k}`).id = `activites_action_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`ajouter_activite_${effetNum}.${j}.${k}`).id = `ajouter_activite_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`ajouter_activite_${effetNum}.${j-1}.${k}`).setAttribute('onclick', `ajouterActivite(${effetNum}, ${j-1}, ${k})`);
                        document.getElementById(`supprimer_action_${effetNum}.${j}.${k}`).id = `supprimer_action_${effetNum}.${j-1}.${k}`;
                        document.getElementById(`supprimer_action_${effetNum}.${j-1}.${k}`).setAttribute('onclick', `supprimerAction(${effetNum}, ${j-1}, ${k})`);
                        
                        for (let l = 1; l <= activiteCounts[`${effetNum}.${j}.${k}`]; l++) {
                            document.getElementById(`activite_${effetNum}.${j}.${k}.${l}`).id = `activite_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_id_${effetNum}.${j}.${k}.${l}`).id = `activite_id_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_id_${effetNum}.${j-1}.${k}.${l}`).textContent = `Activité ${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_label_${effetNum}.${j}.${k}.${l}`).id = `activite_label_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_label_${effetNum}.${j-1}.${k}.${l}`).textContent = `Intitulé de l'activité ${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_titre_${effetNum}.${j}.${k}.${l}`).id = `activite_titre_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`activite_titre_${effetNum}.${j-1}.${k}.${l}`).name = `activite_titre_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`supprimer_activite_${effetNum}.${j}.${k}.${l}`).id = `supprimer_activite_${effetNum}.${j-1}.${k}.${l}`;
                            document.getElementById(`supprimer_activite_${effetNum}.${j-1}.${k}.${l}`).setAttribute('onclick', `supprimerActivite(${effetNum}, ${j-1}, ${k}, ${l})`);
                            document.getElementById(`cibles_periodes_couts_${effetNum}.${j}.${k}.${l}`).id = `cibles_periodes_couts_${effetNum}.${j-1}.${k}.${l}`;
                        }
                    }
                }

                produitCounts[`${effetNum}`]--;
                delete actionCounts[`${effetNum}.${produitNum}`];
                for (let j = produitNum; j < produitCounts[`${effetNum}`]; j++) {
                    actionCounts[`${effetNum}.${j}`] = actionCounts[`${effetNum}.${j+1}`] || 0;
                    delete actionCounts[`${effetNum}.${j+1}`];
                    for (let k = 1; k <= actionCounts[`${effetNum}.${j}`]; k++) {
                        activiteCounts[`${effetNum}.${j}.${k}`] = activiteCounts[`${effetNum}.${j+1}.${k}`] || 0;
                        delete activiteCounts[`${effetNum}.${j+1}.${k}`];
                    }
                }
                mettreAJourStatistiques();
            }
        }

        // Ajouter une action
        function ajouterAction(effetNum, produitNum) {
            actionCounts[`${effetNum}.${produitNum}`]++;
            const actionNum = actionCounts[`${effetNum}.${produitNum}`];
            activiteCounts[`${effetNum}.${produitNum}.${actionNum}`] = 0;

            const actionContainer = document.createElement('div');
            actionContainer.className = 'card shadow-lg p-4 mb-4 border border-info rounded-3 bg-light';
            actionContainer.id = `action_${effetNum}.${produitNum}.${actionNum}`;
            actionContainer.innerHTML = `
                <h6 class="text-info" id="action_id_${effetNum}.${produitNum}.${actionNum}">Action ${effetNum}.${produitNum}.${actionNum}</h6>
                <div class="mb-3">
                    <label for="action_titre_${effetNum}.${produitNum}.${actionNum}" class="form-label" id="action_label_${effetNum}.${produitNum}.${actionNum}">Intitulé de l'action ${effetNum}.${produitNum}.${actionNum}</label>
                    <input type="text" class="form-control shadow-sm border-info" id="action_titre_${effetNum}.${produitNum}.${actionNum}" name="action_titre_${effetNum}.${produitNum}.${actionNum}" required>
                </div>
                <div id="activites_action_${effetNum}.${produitNum}.${actionNum}" class="ps-4"></div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-info me-2 shadow-sm" id="ajouter_activite_${effetNum}.${produitNum}.${actionNum}" onclick="ajouterActivite(${effetNum}, ${produitNum}, ${actionNum})">Ajouter une activité</button>
                    <button type="button" class="btn btn-outline-danger shadow-sm" id="supprimer_action_${effetNum}.${produitNum}.${actionNum}" onclick="supprimerAction(${effetNum}, ${produitNum}, ${actionNum})">Supprimer l'action</button>
                </div>
            `;
            document.getElementById(`actions_produit_${effetNum}.${produitNum}`).appendChild(actionContainer);
            mettreAJourStatistiques();
        }

        // Supprimer une action
        function supprimerAction(effetNum, produitNum, actionNum) {
            const confirmation = confirm(`Êtes-vous sûr de vouloir supprimer l'action ${effetNum}.${produitNum}.${actionNum} ?`);
            effetNum = Number(effetNum);
            produitNum = Number(produitNum);
            actionNum = Number(actionNum);

            if (confirmation) {
                const action = document.getElementById(`action_${effetNum}.${produitNum}.${actionNum}`);
                action.parentNode.removeChild(action);

                for (let k = actionNum + 1; k <= actionCounts[`${effetNum}.${produitNum}`]; k++) {
                    document.getElementById(`action_${effetNum}.${produitNum}.${k}`).id = `action_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_id_${effetNum}.${produitNum}.${k}`).id = `action_id_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_id_${effetNum}.${produitNum}.${k - 1}`).textContent = `Action ${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_label_${effetNum}.${produitNum}.${k}`).id = `action_label_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_label_${effetNum}.${produitNum}.${k - 1}`).textContent = `Intitulé de l'action ${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_titre_${effetNum}.${produitNum}.${k}`).id = `action_titre_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`action_titre_${effetNum}.${produitNum}.${k - 1}`).name = `action_titre_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`activites_action_${effetNum}.${produitNum}.${k}`).id = `activites_action_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`ajouter_activite_${effetNum}.${produitNum}.${k}`).id = `ajouter_activite_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`ajouter_activite_${effetNum}.${produitNum}.${k - 1}`).setAttribute('onclick', `ajouterActivite(${effetNum}, ${produitNum}, ${k - 1})`);
                    document.getElementById(`supprimer_action_${effetNum}.${produitNum}.${k}`).id = `supprimer_action_${effetNum}.${produitNum}.${k - 1}`;
                    document.getElementById(`supprimer_action_${effetNum}.${produitNum}.${k - 1}`).setAttribute('onclick', `supprimerAction(${effetNum}, ${produitNum}, ${k - 1})`);
                    
                    for (let l = 1; l <= activiteCounts[`${effetNum}.${produitNum}.${k}`]; l++) {
                        document.getElementById(`activite_${effetNum}.${produitNum}.${k}.${l}`).id = `activite_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_id_${effetNum}.${produitNum}.${k}.${l}`).id = `activite_id_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_id_${effetNum}.${produitNum}.${k-1}.${l}`).textContent = `Activité ${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_label_${effetNum}.${produitNum}.${k}.${l}`).id = `activite_label_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_label_${effetNum}.${produitNum}.${k-1}.${l}`).textContent = `Intitulé de l'activité ${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_titre_${effetNum}.${produitNum}.${k}.${l}`).id = `activite_titre_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`activite_titre_${effetNum}.${produitNum}.${k-1}.${l}`).name = `activite_titre_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`supprimer_activite_${effetNum}.${produitNum}.${k}.${l}`).id = `supprimer_activite_${effetNum}.${produitNum}.${k-1}.${l}`;
                        document.getElementById(`supprimer_activite_${effetNum}.${produitNum}.${k-1}.${l}`).setAttribute('onclick', `supprimerActivite(${effetNum}, ${produitNum}, ${k-1}, ${l})`);
                        document.getElementById(`cibles_periodes_couts_${effetNum}.${produitNum}.${k}.${l}`).id = `cibles_periodes_couts_${effetNum}.${produitNum}.${k-1}.${l}`;
                    }
                }

                actionCounts[`${effetNum}.${produitNum}`]--;
                delete activiteCounts[`${effetNum}.${produitNum}.${actionNum}`];
                for (let k = actionNum; k < actionCounts[`${effetNum}.${produitNum}`]; k++) {
                    activiteCounts[`${effetNum}.${produitNum}.${k}`] = activiteCounts[`${effetNum}.${produitNum}.${k+1}`] || 0;
                    delete activiteCounts[`${effetNum}.${produitNum}.${k+1}`];
                }
                mettreAJourStatistiques();
            }
        }

        // Générer dynamiquement les champs cibles, périodes et coûts combinés
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("horizon").addEventListener("input", updateResults);
            document.getElementById("annee_depart").addEventListener("input", updateResults);
        });

        function updateResults() {
            let horizonInput = document.getElementById("horizon");
            let anneeDepartInput = document.getElementById("annee_depart");

            let horizon = parseInt(horizonInput.value) || 1;
            let anneeDepart = parseInt(anneeDepartInput.value) || 2010;

            if (horizon > 0 && anneeDepart > 0) {
                document.querySelectorAll(".activite-container").forEach((activite) => {
                    const ids = activite.id.split("_")[1].split(".");
                    const [effetNum, produitNum, actionNum, activiteNum] = ids.map(Number);
                    generateCiblesPeriodesCouts(anneeDepart, horizon, effetNum, produitNum, actionNum, activiteNum);
                });
            }
        }

        function generateCiblesPeriodesCouts(anneeDepart, horizon, effetNum, produitNum, actionNum, activiteNum) {
            let ciblesPeriodesCoutsContainer = document.getElementById(`cibles_periodes_couts_${effetNum}.${produitNum}.${actionNum}.${activiteNum}`);
            ciblesPeriodesCoutsContainer.innerHTML = "";

            for (let i = 0; i < horizon; i++) {
                let yearContainer = document.createElement("div");
                yearContainer.className = "row mb-3 p-3 border rounded bg-white shadow-sm";

                // Colonne pour la cible (toujours un textarea)
                let cibleCol = document.createElement("div");
                cibleCol.className = "col-md-4";
                cibleCol.innerHTML = `
                    <label class="form-label fw-bold text-primary">Cible ${anneeDepart + i}</label>
                    <textarea class="form-control border-primary shadow-sm cible-textarea" 
                        id="cible_${effetNum}.${produitNum}.${actionNum}.${activiteNum}_${i}" 
                        name="cible_${effetNum}.${produitNum}.${actionNum}.${activiteNum}[${i + 1}]" 
                        placeholder="Cible ${anneeDepart + i}"></textarea>
                `;

                // Colonne pour le coût
                let coutCol = document.createElement("div");
                coutCol.className = "col-md-3";
                coutCol.innerHTML = `
                    <label class="form-label fw-bold text-primary">Coût ${anneeDepart + i}</label>
                    <input type="number" class="form-control border-primary shadow-sm" 
                        name="cout_${effetNum}.${produitNum}.${actionNum}.${activiteNum}[${i + 1}]" 
                        placeholder="Coût ${anneeDepart + i}">
                `;

                // Colonne pour les trimestres
                let periodesCol = document.createElement("div");
                periodesCol.className = "col-md-5";
                periodesCol.innerHTML = `
                    <label class="form-label fw-bold text-primary">Trimestres ${anneeDepart + i}</label>
                    <div class="d-flex justify-content-between">
                        ${[1, 2, 3, 4].map(trimestre => `
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" 
                                    id="periode_${effetNum}.${produitNum}.${actionNum}.${activiteNum}_${i}_${trimestre}" 
                                    name="periode_${effetNum}.${produitNum}.${actionNum}.${activiteNum}[${i}][${trimestre}]">
                                <label class="form-check-label" for="periode_${effetNum}.${produitNum}.${actionNum}.${activiteNum}_${i}_${trimestre}">T${trimestre}</label>
                            </div>
                        `).join('')}
                    </div>
                `;

                yearContainer.appendChild(cibleCol);
                yearContainer.appendChild(coutCol);
                yearContainer.appendChild(periodesCol);
                ciblesPeriodesCoutsContainer.appendChild(yearContainer);
            }

            // Ajouter un événement pour ajuster dynamiquement la hauteur des textareas
            document.querySelectorAll(".cible-textarea").forEach(textarea => {
                textarea.addEventListener("input", function() {
                    this.style.height = "auto"; // Réinitialiser pour calculer la hauteur réelle
                    this.style.height = `${this.scrollHeight}px`; // Ajuster à la hauteur du contenu
                });

                // Ajuster la hauteur au focus et au blur pour un effet élégant
                textarea.addEventListener("focus", function() {
                    if (this.value === "") {
                        this.style.height = "38px"; // Garder la hauteur initiale si vide
                    }
                });

                textarea.addEventListener("blur", function() {
                    if (this.value === "") {
                        this.style.height = "38px"; // Revenir à la hauteur initiale si vide
                    }
                });
            });
        }

        // Ajouter une activité
        function ajouterActivite(effetNum, produitNum, actionNum) {
            activiteCounts[`${effetNum}.${produitNum}.${actionNum}`]++;
            const activiteNum = activiteCounts[`${effetNum}.${produitNum}.${actionNum}`];

            const activiteContainer = document.createElement("div");
            activiteContainer.className = "card shadow-lg p-3 mb-2 border border-primary rounded-3 bg-light activite-container";
            activiteContainer.id = `activite_${effetNum}.${produitNum}.${actionNum}.${activiteNum}`;

            activiteContainer.innerHTML = `
            <h6 class="text-primary" id="activite_id_${effetNum}.${produitNum}.${actionNum}.${activiteNum}">Activité ${effetNum}.${produitNum}.${actionNum}.${activiteNum}</h6>

            <div class="mb-3">
                <label for="activite_titre_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" class="form-label" id="activite_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}">
                    Intitulé de l'activité
                </label>
                <input type="text" class="form-control shadow-sm border-primary" 
                    id="activite_titre_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    name="activite_titre_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    required>
            </div>

            <div class="mb-3">
                <label for="activite_type_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" class="form-label" id="activite_type_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}">
                    Type d'activité
                </label>
                <select class="form-control shadow-sm border-primary" 
                    id="activite_type_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    name="activite_type_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    required>
                    <option value="Réforme">Réforme</option>
                    <option value="Investissement">Investissement</option>
                    <option value="Etude">Étude</option>
                    <option value="Texte">Texte</option>
                    <option value="Activité ordinaire">Activité ordinaire</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="indicateur_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" class="form-label" id="activite_indicateur_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}">
                    Libellé de l'indicateur
                </label>
                <input type="text" class="form-control shadow-sm border-primary" 
                    id="indicateur_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    name="indicateur_label_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    required>
            </div>

            <div class="mb-3">
                <label for="indicateur_reference_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" class="form-label" id="activite_indicateur_reference_${effetNum}.${produitNum}.${actionNum}.${activiteNum}">
                    Référence de l'indicateur
                </label>
                <input type="text" class="form-control shadow-sm border-primary" 
                    id="indicateur_reference_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    name="indicateur_reference_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold text-primary">Cibles, Périodes d'exécution et Coûts</label>
                <div id="cibles_periodes_couts_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" class="bg-light p-2 rounded">
                    <!-- Afficher dynamiquement les cibles, périodes et coûts ici -->
                </div>
            </div>

            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-danger mt-2 shadow-sm" 
                    id="supprimer_activite_${effetNum}.${produitNum}.${actionNum}.${activiteNum}" 
                    onclick="supprimerActivite(${effetNum}, ${produitNum}, ${actionNum}, ${activiteNum})">
                    Supprimer l'activité
                </button>
            </div>
            `;

            document.getElementById(`activites_action_${effetNum}.${produitNum}.${actionNum}`).appendChild(activiteContainer);
            updateResults();
            mettreAJourStatistiques();
        }

        // Supprimer une activité
        function supprimerActivite(effetNum, produitNum, actionNum, activiteNum) {
            const confirmation = confirm(`Êtes-vous sûr de vouloir supprimer l'activité ${effetNum}.${produitNum}.${actionNum}.${activiteNum} ?`);
            effetNum = Number(effetNum);
            produitNum = Number(produitNum);
            actionNum = Number(actionNum);
            activiteNum = Number(activiteNum);

            if (confirmation) {
                document.getElementById(`activite_${effetNum}.${produitNum}.${actionNum}.${activiteNum}`).remove();

                for (let l = activiteNum + 1; l <= activiteCounts[`${effetNum}.${produitNum}.${actionNum}`]; l++) {
                    document.getElementById(`activite_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `activite_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_id_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `activite_id_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_id_${effetNum}.${produitNum}.${actionNum}.${l - 1}`).textContent = `Activité ${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_label_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `activite_label_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_label_${effetNum}.${produitNum}.${actionNum}.${l - 1}`).textContent = `Intitulé de l'activité ${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_titre_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `activite_titre_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`activite_titre_${effetNum}.${produitNum}.${actionNum}.${l - 1}`).name = `activite_titre_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                    document.getElementById(`supprimer_activite_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `supprimer_activite_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;                    
                    document.getElementById(`supprimer_activite_${effetNum}.${produitNum}.${actionNum}.${l - 1}`).setAttribute('onclick', `supprimerActivite(${effetNum}, ${produitNum}, ${actionNum}, ${l - 1})`);
                    document.getElementById(`cibles_periodes_couts_${effetNum}.${produitNum}.${actionNum}.${l}`).id = `cibles_periodes_couts_${effetNum}.${produitNum}.${actionNum}.${l - 1}`;
                }

                activiteCounts[`${effetNum}.${produitNum}.${actionNum}`]--;
                mettreAJourStatistiques();
            }
        }
    </script>
{% endblock %}