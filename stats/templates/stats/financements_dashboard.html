{% extends 'index-stats.html' %}
{% load static %}
{% load table_tags %}

{% block content %}
<style>
    /* Animation pour le conteneur du graphique */
    #crossed-histogram {
    overflow: hidden; /* Évite les débordements pendant l’animation */
    }

    /* Classe temporaire pour l’animation d’entrée */
    .slide-from-left {
    animation: slideFromLeft 0.5s ease-out forwards;
    }

    @keyframes slideFromLeft {
    0% {
        transform: translateX(-100%); /* Départ à gauche, hors écran */
        opacity: 0;
    }
    100% {
        transform: translateX(0); /* Arrivée à la position normale */
        opacity: 1;
    }
    }
</style>
  </head>
  <!--end::Head-->
  <!--begin::Body-->

      <!--end::Header-->
      <!--begin::Sidebar-->
<!-- Sidebar -->
<aside class="app-sidebar shadow">
    <div class="sidebar-brand" style="background-color: #FF6200;">
      <a href="#" class="brand-link">
        <img src="{% static 'adminlte/dist/assets/img/DPSE_logo_1 sans arrière plan.png' %}" alt="AdminLTE Logo" class="brand-image" />
        <span class="brand-text fw-light">Dashboard DPSE</span>
      </a>
    </div>
    <div class="sidebar-wrapper">
      <nav class="mt-2">
        <ul class="nav sidebar-menu flex-column" data-lte-toggle="treeview" role="menu" data-accordion="false">
          <li class="nav-item menu-open">
            <a href="#" class="nav-link active" style="background-color: #049639;">
              <i class="nav-icon bi bi-speedometer"></i>
              <p>
                Dashboards
                <i class="nav-arrow bi bi-chevron-right"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="{% url 'dashboard_TOFE' %}" class="nav-link {% if request.path == '/stats/dashboard_TOFE/' %}active{% endif %}">
                  <i class="nav-icon bi bi-circle"></i>
                  <p>TOFE</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="{% url 'douanes_dashboard' %}" class="nav-link {% if request.path == '/stats/douanes_dashboard/' %}active{% endif %}">
                  <i class="nav-icon bi bi-circle"></i>
                  <p>Douanes</p>
                </a>
              </li>
              <li class="nav-item {% if request.path == '/stats/financements_dashboard/' %}menu-open{% endif %}">
                <a href="{% url 'financements_dashboard' %}" class="nav-link {% if request.path == '/stats/financements_dashboard/' %}active{% endif %}" id="financements-toggle" style="background-color:#388855">
                  <i class="nav-icon bi bi-circle"></i>
                  <p>
                    Financements
                    <i class="nav-arrow bi bi-chevron-right"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  {% for tableau in tableaux %}
                    <li class="nav-item">
                      <a href="#" class="nav-link tableau-link {% if forloop.first %}active{% endif %}" data-tableau-id="{{ tableau.id }}">
                        <i class="nav-icon bi bi-table"></i>
                        <p data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="{{ tableau.name|split:': '|slice:'1:'|join:'' }}">{{ tableau.name|split:": "|slice:"1:"|join:"" }}</p>
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-circle"></i>
                  <p>Marchés publics</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link">
                  <i class="nav-icon bi bi-circle"></i>
                  <p>Suivi du PEF</p>
                </a>
              </li>
            </ul>
          </li>
            </ul>
            <!--end::Sidebar Menu-->
          </nav>
        </div>
        <!--end::Sidebar Wrapper-->
      </aside>

      <!-- Contenu principal -->
      <main class="app-main">
        <div class="app-content-header">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6"><h3 class="mb-0">Dashboard Financements</h3></div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Dashboard Financements</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        <!-- Nouvelles cartes KPI -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text" style="background-color: #dff3e7;"> <!-- Orange vif -->
                    <div class="card-body">
                        <h5>Dette extérieure 2023</h5>
                        <p class="card-text">18 622,6 Mds FCFA</p>
                        <small>
                            <span class="text-success"><i class="fas fa-arrow-up"></i> +7,87%</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text" style="background-color:#dff3e7;"> <!-- Vert foncé -->
                    <div class="card-body">
                        <h5>Dette intérieure 2024</h5>
                        <p class="card-text">11 787,2 Mds FCFA</p>
                        <small>
                            <span class="text-success"><i class="fas fa-arrow-up"></i> +9,84%</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text" style="background-color:#dff3e7;"> <!-- Orange vif -->
                    <div class="card-body">
                        <h5>Dette totale 2023 (% PIB)</h5>
                        <p class="card-text">58,1%</p>
                        <small>
                            <span class="text-success"><i class="fas fa-arrow-up"></i> +1,5 pts de %</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text" style="background-color: #dff3e7;"> <!-- Vert foncé -->
                    <div class="card-body">
                        <h5>Paiement intérêts 2023 (% PIB)</h5>
                        <p class="card-text">2,6%</p>
                        <small>
                            <span class="text-success"><i class="fas fa-arrow-minus"></i> +0,4 pts de %</span>
                        </small>
                    </div>
                </div>
            </div>
            </div>

        <div class="app-content">
          <div class="container-fluid">

            <!-- Graphiques -->
            <div class="row">
              <div class="col-md-8">
                <div class="card mb-4" style="border: 1px solid #FF6200;">
                  <div class="card-header" style="background-color: #009A49; color: #FFFFFF;">
                    <h3 class="card-title">Évolution des Indicateurs (2020-2028)</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="variableSelector" class="form-label">Choisir les variables :</label>
                      <select id="variableSelector" multiple class="form-select" size="6"></select>
                      <small class="text-muted">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs variables.</small>
                    </div>
                    <div class="mb-3">
                      <label for="typeSelector" class="form-label">Type de graphique :</label>
                      <select id="typeSelector" class="form-select">
                        <option value="line" selected>Ligne</option>
                        <option value="area">Aire</option>
                      </select>
                    </div>
                    <div id="evolution-chart" style="min-height: 300px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="card mb-4" style="border: 1px solid #FF6200;">
                  <div class="card-header" style="background-color: #009A49; color: #FFFFFF;">
                    <h3 class="card-title">Répartition (2024)</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="pieSelector" class="form-label">Choisir une variable :</label>
                      <select id="pieSelector" class="form-select"></select>
                    </div>
                    <div id="pie-chart" style="min-height: 300px;"></div>
                    <div id="bar-chart" style="height: 120px; margin-top: 55px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Histogramme croisé -->
            <div class="row">
              <div class="col-md-12">
                <div class="card mt-4 mb-4" style="border: 1px solid #FF6200;">
                  <div class="card-header" style="background-color: #009A49; color: #FFFFFF;">
                    <h3 class="card-title">Histogramme Croisé à Deux Variables</h3>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-4">
                        <label for="xSelector" class="form-label">Variable X :</label>
                        <select id="xSelector" class="form-select"></select>
                      </div>
                      <div class="col-md-4">
                        <label for="ySelector" class="form-label">Variable Y :</label>
                        <select id="ySelector" class="form-select"></select>
                      </div>
                      <div class="col-md-4">
                        <label for="stackSelector" class="form-label">Type d’affichage :</label>
                        <select id="stackSelector" class="form-select">
                          <option value="stacked" selected>Empilé</option>
                          <option value="grouped">Étalé</option>
                        </select>
                      </div>
                    </div>
                    <div id="crossed-histogram" style="min-height: 300px;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tableau -->
            <div class="row">
              <div class="col-md-12">
                <div class="card mt-4" style="border: 1px solid #FF6200;">
                  <div class="card-header" style="background-color: #009A49; color: #FFFFFF;">
                    <h3 class="card-title">Données du Tableau Sélectionné</h3>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <input type="text" id="globalSearch" class="form-control" placeholder="Rechercher dans toutes les colonnes..." style="border-color: #FF6200;">
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                      <table id="dataTable" class="table table-hover">
                        <thead>
                          <tr id="tableHeader"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Footer -->
      <footer class="app-footer">
        <div class="float-end d-none d-sm-inline">Tous droits réservés.</div>
        <strong>Copyright - Direction de la Planification et du Suivi-Evaluation du MFB Côte d'Ivoire © 2025 <a href="#" class="text-decoration-none">DPSE</a>.</strong>
      </footer>
    </div>
    {% endblock %}
    <!--begin::Script-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    {% block scripts %}
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js" integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="{% static 'adminlte/dist/js/adminlte.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>

    <script>
        function loadTableauData(tableauId) {
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
                .then(response => response.json())
                .then(data => {
                if (data.error) {
                    console.error('Erreur:', data.error);
                    return;
                }
                console.log(`Données pour tableau ${tableauId}:`, data);

                updateVariableSelectors(data.all_data);

                const defaultEvolutionVar = Object.keys(data.all_data)[0] || 'FINANCEMENTS TOTAUX';
                const defaultPieVar = Object.keys(data.all_data)[0] || 'FINANCEMENTS TOTAUX';
                const defaultXVar = Object.keys(data.all_data)[0] || 'FINANCEMENTS TOTAUX';
                const defaultYVar = Object.keys(data.all_data)[1] || defaultXVar;

                if (window.evolutionChart) window.evolutionChart.destroy();
                if (window.pieChart) window.pieChart.destroy();
                if (window.barChart) window.barChart.destroy();
                if (window.crossedHistogram) window.crossedHistogram.destroy();

                updateEvolutionChart([defaultEvolutionVar], 'line', data);
                updatePieChart(defaultPieVar, data);
                updateCrossedHistogram(defaultXVar, defaultYVar, 'stacked', data);
                updateTable(data);

                // Mettre à jour l'état actif dans la sidebar
                document.querySelectorAll('.tableau-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-tableau-id') === tableauId) {
                    link.classList.add('active');
                    // Mettre à jour le titre avec le libellé du tableau actif, sans ID
                    const tableauLabel = link.querySelector('p').textContent; // Maintenant sans ID grâce au HTML
                    document.getElementById('selected-tableau-title').textContent = tableauLabel;
                    }
                });
                })
                .catch(error => console.error('Erreur AJAX:', error));
            }
      
            function updateVariableSelectors(allData) {
                const variableSelector = document.getElementById('variableSelector');
                const pieSelector = document.getElementById('pieSelector');
                const xSelector = document.getElementById('xSelector');
                const ySelector = document.getElementById('ySelector');

                variableSelector.innerHTML = '';
                pieSelector.innerHTML = '';
                xSelector.innerHTML = '';
                ySelector.innerHTML = '';

                Object.keys(allData).forEach((categorie, index) => {
                    const option = document.createElement('option');
                    option.value = categorie;
                    option.textContent = categorie;
                    if (index === 0) option.selected = true;
                    variableSelector.appendChild(option.cloneNode(true));
                    pieSelector.appendChild(option.cloneNode(true));
                    xSelector.appendChild(option.cloneNode(true));
                    if (index === 1) option.selected = true;
                    ySelector.appendChild(option.cloneNode(true));
                });
                }

                function getUnitFromLabel(label) {
                    if (label.includes('(années)')) return 'années';
                    if (label.includes('%')) return 'pourcentage';
                    return 'milliards';
                }
                    
                function updateEvolutionChart(selectedVariables, chartType, data) {
                    const series = selectedVariables.map(variable => ({
                        name: variable,
                        data: data.all_data[variable] || []
                    }));

                    // Déterminer l’unité dominante (priorité : années > pourcentage > milliards)
                    const units = selectedVariables.map(getUnitFromLabel);
                    const unit = units.includes('années') ? 'années' 
                                : units.includes('pourcentage') ? 'pourcentage' 
                                : 'milliards';

                    const chartOptions = {
                        series: series,
                        chart: { 
                        height: 300, 
                        type: chartType, 
                        toolbar: { show: true },
                        animations: {
                            enabled: true,
                            easing: 'linear',
                            speed: 1000,
                            animateGradually: { enabled: false },
                            dynamicAnimation: { enabled: true, speed: 800 }
                        }
                        },
                        colors: ['#FF6200', '#009A49', '#FFD700', '#FF4500', '#1E90FF'],
                        stroke: { curve: 'smooth', width: 4, dashArray: 0 },
                        dataLabels: { enabled: true },
                        xaxis: { 
                        type: 'category', 
                        categories: data.years.map(String),
                        title: { text: 'Années' },
                        labels: { rotate: -45, trim: false, formatter: function(val) { return val; } }
                        },
                        yaxis: { 
                        title: { 
                            text: unit === 'années' ? 'Années' 
                                : unit === 'pourcentage' ? 'Pourcentage (%)' 
                                : 'Milliards FCFA' 
                        }
                        },
                        legend: { position: 'top' },
                        tooltip: { 
                        y: { 
                            formatter: val => unit === 'années' ? val.toFixed(1) + ' ans' 
                                            : unit === 'pourcentage' ? val.toFixed(2) + ' %' 
                                            : val.toFixed(2) + ' Mds FCFA' 
                        } 
                        },
                        animations: {
                        initialAnimation: {
                            enabled: true,
                            easing: 'linear',
                            speed: 1000,
                            animatePaths: true
                        }
                        }
                    };

                    window.evolutionChart = new ApexCharts(document.querySelector('#evolution-chart'), chartOptions);
                    window.evolutionChart.render();
                    }
      
                    function updatePieChart(selectedVariable, data) {
                        const pieData = (data.all_data[selectedVariable] || []).map(val => {
                            const num = parseFloat(val);
                            return isNaN(num) ? 0 : num;
                        });
                        
                        console.log('Données pour pie-chart:', { variable: selectedVariable, series: pieData, labels: data.years });

                        const unit = getUnitFromLabel(selectedVariable);

                        const pieOptions = {
                            series: pieData,
                            chart: { height: 300, type: 'donut' },
                            labels: data.years.map(String),
                            colors: ['#FF6200', '#009A49', '#FFD700', '#FF4500', '#1E90FF'],
                            legend: { position: 'bottom' },
                            tooltip: { 
                            y: { 
                                formatter: val => unit === 'années' ? val.toFixed(1) + ' ans' 
                                                : unit === 'pourcentage' ? val.toFixed(2) + ' %' 
                                                : val.toFixed(2) + ' Mds FCFA' 
                            } 
                            },
                            responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
                        };

                        if (window.pieChart) window.pieChart.destroy();
                        window.pieChart = new ApexCharts(document.querySelector('#pie-chart'), pieOptions);
                        window.pieChart.render();

                        updateBarChart(selectedVariable, data);
                        }
      
                    function updateBarChart(selectedVariable, data) {
                        const unit = getUnitFromLabel(selectedVariable);

                        const barOptions = {
                            series: [{ name: selectedVariable, data: data.all_data[selectedVariable] || [] }],
                            chart: { height: 200, type: 'bar' },
                            plotOptions: { bar: { horizontal: true, barHeight: '80%' } },
                            colors: ['#009A49'],
                            dataLabels: { enabled: false },
                            xaxis: { 
                            categories: data.years.map(String), 
                            title: { 
                                text: unit === 'années' ? 'Années' 
                                    : unit === 'pourcentage' ? 'Pourcentage (%)' 
                                    : 'Milliards FCFA' 
                            }
                            },
                            yaxis: { 
                            title: { text: 'Années' }, 
                            labels: { trim: false, formatter: function(val) { return val; } }
                            },
                            tooltip: { 
                            y: { 
                                formatter: val => unit === 'années' ? val.toFixed(1) + ' ans' 
                                                : unit === 'pourcentage' ? val.toFixed(2) + ' %' 
                                                : val.toFixed(2) + ' Mds FCFA' 
                            } 
                            }
                        };

                        window.barChart = new ApexCharts(document.querySelector('#bar-chart'), barOptions);
                        window.barChart.render();
                        }
      
                    function updateCrossedHistogram(xVariable, yVariable, stackType, data) {
                        const series = [
                            { name: xVariable, data: data.all_data[xVariable] || [] },
                            { name: yVariable, data: data.all_data[yVariable] || [] }
                        ];

                        const xUnit = getUnitFromLabel(xVariable);
                        const yUnit = getUnitFromLabel(yVariable);

                        let yaxisConfig;
                        let tooltipFormatter;

                        if (xUnit === yUnit) {
                            // Même unité : un seul axe Y
                            const unitText = xUnit === 'années' ? 'Années' 
                                            : xUnit === 'pourcentage' ? 'Pourcentage (%)' 
                                            : 'Milliards FCFA';
                            yaxisConfig = { title: { text: unitText } };
                            tooltipFormatter = val => xUnit === 'années' ? val.toFixed(1) + ' ans' 
                                                : xUnit === 'pourcentage' ? val.toFixed(2) + ' %' 
                                                : val.toFixed(2) + ' Mds FCFA';
                        } else {
                            // Unités différentes : deux axes Y
                            yaxisConfig = [
                            {
                                seriesName: xVariable,
                                title: { 
                                text: xUnit === 'années' ? 'Années' 
                                    : xUnit === 'pourcentage' ? 'Pourcentage (%)' 
                                    : 'Milliards FCFA' 
                                },
                                labels: { formatter: val => val.toFixed(xUnit === 'années' ? 1 : 2) }
                            },
                            {
                                seriesName: yVariable,
                                opposite: true,
                                title: { 
                                text: yUnit === 'années' ? 'Années' 
                                    : yUnit === 'pourcentage' ? 'Pourcentage (%)' 
                                    : 'Milliards FCFA' 
                                },
                                labels: { formatter: val => val.toFixed(yUnit === 'années' ? 1 : 2) }
                            }
                            ];
                            tooltipFormatter = function(val, { seriesIndex }) {
                            const unit = seriesIndex === 0 ? xUnit : yUnit;
                            return unit === 'années' ? val.toFixed(1) + ' ans' 
                                : unit === 'pourcentage' ? val.toFixed(2) + ' %' 
                                : val.toFixed(2) + ' Mds FCFA';
                            };
                        }

                        const histOptions = {
                            series: series,
                            chart: { 
                            height: 300, 
                            type: 'bar', 
                            stacked: stackType === 'stacked', 
                            toolbar: { show: true },
                            animations: { enabled: true, easing: 'easeinout', speed: 500, animateGradually: { enabled: false }, dynamicAnimation: { enabled: true, speed: 500, easing: 'easeinout' } }
                            },
                            plotOptions: { bar: { horizontal: false, columnWidth: '55%' } },
                            colors: ['#FF6200', '#009A49'],
                            dataLabels: { enabled: false },
                            xaxis: { 
                            type: 'category', 
                            categories: data.years.map(String), 
                            title: { text: 'Années' }, 
                            labels: { rotate: -45, trim: false, formatter: function(val) { return val; } }
                            },
                            yaxis: yaxisConfig,
                            legend: { position: 'top' },
                            tooltip: { y: { formatter: tooltipFormatter } }
                        };

                        const chartElement = document.querySelector('#crossed-histogram');
                        window.crossedHistogram = new ApexCharts(chartElement, histOptions);
                        window.crossedHistogram.render();
                        }
      
        function updateTable(data) {
          const thead = document.getElementById('tableHeader');
          thead.innerHTML = `<th>Catégorie</th>${data.years.map(year => `<th>${year}</th>`).join('')}`;
          const tbody = document.getElementById('tableBody');
          tbody.innerHTML = '';
          data.table_data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${row[0]}</td>${row.slice(1).map(value => `<td>${value}</td>`).join('')}`;
            tbody.appendChild(tr);
          });
        }
      
        document.addEventListener('DOMContentLoaded', function () {
          // Empêcher la navigation sur le lien "Dashboard Financements"
          const financementsToggle = document.getElementById('financements-toggle');
          financementsToggle.addEventListener('click', function (e) {
            e.preventDefault(); // Empêche le rechargement de la page
            // AdminLTE gère automatiquement le pliage/dépliage via data-lte-toggle
          });
      
          // Écouteur pour les liens des tableaux
          const tableauLinks = document.querySelectorAll('.tableau-link');
          tableauLinks.forEach(link => {
            link.addEventListener('click', function (e) {
              e.preventDefault();
              const tableauId = this.getAttribute('data-tableau-id');
              loadTableauData(tableauId);
            });
          });
      
          // Charger le premier tableau actif par défaut
          const initialTableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
          loadTableauData(initialTableauId);
      
          // Écouteurs pour les sélecteurs de graphiques
          document.getElementById('variableSelector').addEventListener('change', function () {
            const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
            const chartType = document.getElementById('typeSelector').value;
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.evolutionChart) window.evolutionChart.destroy();
                updateEvolutionChart(selectedOptions, chartType, data);
              });
          });
      
          document.getElementById('typeSelector').addEventListener('change', function () {
            const selectedOptions = Array.from(document.getElementById('variableSelector').selectedOptions).map(option => option.value);
            const chartType = this.value;
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.evolutionChart) window.evolutionChart.destroy();
                updateEvolutionChart(selectedOptions, chartType, data);
              });
          });
      
          document.getElementById('pieSelector').addEventListener('change', function () {
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.pieChart) window.pieChart.destroy();
                if (window.barChart) window.barChart.destroy();
                updatePieChart(this.value, data);
              });
          });
      
          document.getElementById('xSelector').addEventListener('change', function () {
            const xVariable = this.value;
            const yVariable = document.getElementById('ySelector').value;
            const stackType = document.getElementById('stackSelector').value;
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.crossedHistogram) window.crossedHistogram.destroy();
                updateCrossedHistogram(xVariable, yVariable, stackType, data);
              });
          });
      
          document.getElementById('ySelector').addEventListener('change', function () {
            const xVariable = document.getElementById('xSelector').value;
            const yVariable = this.value;
            const stackType = document.getElementById('stackSelector').value;
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.crossedHistogram) window.crossedHistogram.destroy();
                updateCrossedHistogram(xVariable, yVariable, stackType, data);
              });
          });
      
          document.getElementById('stackSelector').addEventListener('change', function () {
            const xVariable = document.getElementById('xSelector').value;
            const yVariable = document.getElementById('ySelector').value;
            const stackType = this.value;
            const tableauId = document.querySelector('.tableau-link.active').getAttribute('data-tableau-id');
            fetch(`{% url 'get_financements_data' %}?tableau_id=${tableauId}`)
              .then(response => response.json())
              .then(data => {
                if (window.crossedHistogram) window.crossedHistogram.destroy();
                updateCrossedHistogram(xVariable, yVariable, stackType, data);
              });
          });
      
          const table = document.getElementById('dataTable');
          const globalSearch = document.getElementById('globalSearch');
      
          function filterTable() {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const searchText = globalSearch.value.toLowerCase();

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowText = Array.from(cells).map(cell => cell.textContent.toLowerCase()).join(' ');

                const matchesSearch = rowText.includes(searchText);
                row.style.display = matchesSearch ? '' : 'none';
            });
            }
      
          globalSearch.addEventListener('input', filterTable);
      
          table.addEventListener('click', function (e) {
            const header = e.target.closest('th');
            if (!header) return;
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const isAscending = header.classList.toggle('asc');
            const columnIndex = Array.from(header.parentElement.children).indexOf(header);
      
            rows.sort((a, b) => {
              const aValue = a.cells[columnIndex].textContent;
              const bValue = b.cells[columnIndex].textContent;
              if (columnIndex === 0) {
                return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
              } else {
                return isAscending ? parseFloat(aValue) - parseFloat(bValue) : parseFloat(bValue) - parseFloat(aValue);
              }
            });
      
            rows.forEach(row => table.querySelector('tbody').appendChild(row));
            Array.from(table.querySelectorAll('th')).forEach(h => h.classList.remove('asc'));
            header.classList.add('asc');
          });

            // Initialiser les tooltips Bootstrap avec options
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'hover', // Infobulle visible au survol uniquement
            delay: { show:30 , hide: 700 }, // Délai : apparition après 100ms, disparition après 500ms
            boundary: 'window' // Empêche l’infobulle de sortir de la fenêtre
            }));
        });
      </script>
{% endblock %}