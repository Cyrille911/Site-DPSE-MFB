{% load static %}
{% load table_tags %}
<link rel="stylesheet" href="{% static 'adminlte/plugins/fontawesome-free/css/all.min.css' %}">
<!DOCTYPE html>
<html lang="en">
      <!--begin::Head-->
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>AdminLTE v4 | Dashboard</title>
        <!--begin::Primary Meta Tags-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="title" content="AdminLTE v4 | Dashboard" />
        <meta name="author" content="ColorlibHQ" />
        <meta
          name="description"
          content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS."
        />
        <meta
          name="keywords"
          content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard"
        />
        <!--end::Primary Meta Tags-->
        <!--begin::Fonts-->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
          integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
          crossorigin="anonymous"
        />
        <!--end::Fonts-->
        <!--begin::Third Party Plugin(OverlayScrollbars)-->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
          integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg="
          crossorigin="anonymous"
        />
        <!--end::Third Party Plugin(OverlayScrollbars)-->
        <!--begin::Third Party Plugin(Bootstrap Icons)-->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
          integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI="
          crossorigin="anonymous"
        />
        <!--end::Third Party Plugin(Bootstrap Icons)-->
        <!--begin::Required Plugin(AdminLTE)-->
        <link rel="stylesheet" href="{% static 'adminlte/dist/css/adminlte.css' %}" />
        <link rel="stylesheet" href="{% static 'adminlte/custom.css' %}">
        <!--end::Required Plugin(AdminLTE)-->
        <!-- apexcharts -->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
          integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0="
          crossorigin="anonymous"
        />
        <!-- jsvectormap -->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
          integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4="
          crossorigin="anonymous"
        />
        <style>
          #evolution-chart .apexcharts-line-series path {
              stroke-width: 5px !important;
              opacity: 1 !important;
          }
          #pie-chart, #bar-chart {
              max-height: 300px;
          }
          #dataTable th {
              cursor: pointer;
              position: sticky;
              top: 0;
              background: #f9ecd1;
              z-index: 1;
          }
          #dataTable th.asc::after {
              content: ' ↑';
          }
          .table-responsive {
              max-height: 400px;
              overflow-y: auto;
          }
          /* Style des cartes KPI */
          .card {
              border: none;
              border-radius: 8px;
              box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
          }
          .card-body {
              padding: 1rem;
          }
          .card-title {
              font-size: 1.1rem;
              margin-bottom: 0.5rem;
          }
          .card-text {
              font-size: 1.5rem;
              font-weight: bold;
              margin-bottom: 0.25rem;
          }
          .card small {
              font-size: 0.9rem;
          }
          /* Style du tableau */
        #dataTable {
            border-collapse: separate;
            border-spacing: 0;
            background-color: #FFFFFF; /* Fond blanc */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #dataTable th {
            cursor: pointer;
            position: sticky;
            top: 0;
            background-color: #FF6200; /* Orange pour en-têtes */
            color: #FFFFFF;
            border-bottom: 2px solid #FFFFFF; /* Séparation blanche */
            padding: 10px;
        }
        #dataTable th.asc::after {
            content: ' ↑';
        }
        #dataTable td {
            padding: 8px;
            border-bottom: 1px solid #F5F5F5; /* Gris clair subtil */
        }
        #dataTable tr:hover {
            background-color: #FFF5E6; /* Nuance orange pâle au survol */
        }
        #dataTable tbody tr:nth-child(even) {
            background-color: #F9FCF9; /* Nuance verte très pâle pour alternance */
        }
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #009A49; /* Bordure verte */
            border-radius: 4px;
        }
        /* Style de la sidebar */
        .app-sidebar {
        background: #f47729db; /* Dégradé vert */
        color: #FFFFFF !important;
        transition: all 0.3s ease; /* Transition fluide pour les changements */
        }
        .app-sidebar .sidebar-brand .brand-link {
        color: #FFFFFF !important; /* Blanc pour le texte du brand */
        }
    
        .app-sidebar .sidebar-brand .brand-link span.brand-text {
        color: #FFFFFF !important; /* Cible spécifiquement le span */
        }
    
        .app-sidebar .nav-link {
        color: #FFFFFF !important; /* Blanc pour les liens */
        }
    
        .app-sidebar .nav-link p {
        color: #FFFFFF !important; /* Blanc pour le texte dans les <p> */
        }
    
        .app-sidebar .nav-link:hover,
        .app-sidebar .nav-link.active {
        color: #FFFFFF !important; /* Blanc au survol et actif */
        }
        .sidebar-brand {
        background: #1e7e01;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    
        .sidebar-brand:hover {
        transform: scale(1.05); /* Légère expansion */
        box-shadow: 0 4px 10px rgb(247, 109, 3); /* Ombre au survol */
        }
    
        .nav-link {
        color: #f87511;
        position: relative;
        overflow: hidden;
        transition: background-color 0.3s ease, padding-left 0.3s ease;
        }
    
        .nav-link::after {
        content: '';
        position: absolute;
        left: -100%;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(2, 91, 6, 0.101); /* Survol orange translucide */
        transition: left 0.3s ease;
        }
    
        .nav-link:hover, .nav-link.active {
        background-color: #FF8C00;
        padding-left: 25px; /* Décalage à gauche au survol */
        }
    
        .nav-link:hover::after {
        left: 0; /* Glissement de l’effet */
        }
        /* Style de la navbar */
        .app-header {
            background-color: #FF6200; /* Orange pour la barre */
            color: #FFFFFF;
            border-bottom: 2px solid #FFFFFF; /* Séparation subtile */
        }
        .app-header .nav-link {
            color: #FFFFFF;
        }
        .app-header .nav-link:hover {
            background-color: #FF8C00; /* Orange moyen au survol */
        }
        .app-header .navbar-badge {
            background-color: #FFFFFF; /* Badge blanc pour contraste */
            color: #FF6200; /* Texte orange */
        }
        .app-header .dropdown-menu {
            background-color: #FFFFFF; /* Fond blanc pour dropdowns */
            color: #000000;
        }
        .app-header .dropdown-item:hover {
            background-color: #FFF5E6; /* Orange pâle au survol */
        }
                /* Styles pour la barre de recherche */
                .search-container {
            position: relative;
            width: 40px;
            transition: width 0.3s ease-in-out;
        }
        .search-container.active {
            width: 300px;
        }
        #navbar-search {
            width: 0;
            opacity: 0;
            padding: 0;
            border: none;
            transition: width 0.3s ease-in-out, opacity 0.2s ease-in-out, padding 0.3s ease-in-out;
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        .search-container.active #navbar-search {
            width: 100%;
            opacity: 1;
            padding: 6px 12px;
            border: 1px solid #FFFFFF;
            border-radius: 4px;
        }
        #search-toggle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: opacity 0.2s ease-in-out;
        }
        .search-container.active #search-toggle {
            opacity: 0;
            pointer-events: none;
        }
        #search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1000;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0;
            margin: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        #search-suggestions li {
            list-style: none;
            padding: 8px 12px;
            cursor: pointer;
        }
        #search-suggestions li:hover {
            background-color: #f8f9fa;
        }
    </style>
      </head>


<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <!-- Navbar -->
        <nav class="app-header navbar navbar-expand" style="background-color: #FF6200; color: #FFFFFF;">
            <div class="container-fluid">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button" id="sidebar-toggle">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                    <li class="nav-item d-none d-md-block">
                        <a href="{% url 'accueil' %}" class="nav-link">Page d'accueil</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <!-- Barre de recherche avec loupe -->
                    <li class="nav-item search-container">
                        <form id="navbar-search-form">
                            <i class="bi bi-search" id="search-toggle"></i>
                            <input class="form-control" type="search" id="navbar-search" placeholder="Rechercher un tableau..." aria-label="Search">
                            <ul id="search-suggestions" class="dropdown-menu"></ul>
                        </form>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none;"></i>
                        </a>
                    </li>
                    {% if request.user.is_authenticated %}
                        <li class="nav-item">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#profileModal" class="nav-link">
                                {% if request.user.photo %}
                                    <img src="{{ request.user.photo.url }}" class="rounded-circle" width="30" height="30" alt="Photo" style="margin-right: 10px;">
                                {% else %}
                                    <div class="rounded-circle bg-success text-white d-flex justify-content-center align-items-center" style="width: 30px; height: 30px; font-size: 14px; font-weight: bold; margin-right: 10px;">
                                        {{ request.user.first_name|default:''|slice:":1" }}{{ request.user.last_name|default:''|slice:":1" }}
                                    </div>
                                {% endif %}
                                <span>{{ request.user.first_name }} {{ request.user.last_name }}</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" class="nav-link">Se connecter</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </nav>

        <!-- Modale Profil -->
        <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="profileModalLabel">Que souhaitez-vous faire ?</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Voulez-vous voir votre profil ou vous déconnecter ?</p>
                    </div>
                    <div class="modal-footer">
                        <a href="{% url 'profil_utilisateur' %}" class="btn btn-primary">Voir mon profil</a>
                        <a href="{% url 'deconnexion' %}" class="btn btn-danger">Déconnexion</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modale Connexion/Inscription -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalLabel">Se connecter ou s'inscrire</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="choiceStep">
                            <h6>Que souhaitez-vous faire ?</h6>
                            <button class="btn btn-primary mb-2" id="newAccountBtn">Nouvelle inscription</button>
                            <button class="btn btn-secondary mb-2" id="existingAccountBtn">Connexion à un compte existant</button>
                        </div>
                        <div id="userTypeStep1" style="display: none;">
                            <h6>Choisissez votre type d'utilisateur :</h6>
                            <button type="button" class="btn btn-primary" id="membreBtn1">Membre</button>
                            <button type="button" class="btn btn-primary" id="visiteurBtn1">Visiteur</button>
                            <button class="btn btn-link" id="backToChoiceStep1">Retour</button>
                        </div>
                        <div id="userTypeStep2" style="display: none;">
                            <h6>Choisissez votre type d'utilisateur :</h6>
                            <button type="button" class="btn btn-primary" id="membreBtn2">Membre</button>
                            <button type="button" class="btn btn-primary" id="visiteurBtn2">Visiteur</button>
                            <button class="btn btn-link" id="backToChoiceStep2">Retour</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenu principal -->
        {% block content %}{% endblock %}

        <!-- Scripts -->
        {% block scripts %}
        {% endblock %}
        <script>
            // Gestion manuelle du toggle sidebar (solution de secours)
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const body = document.body;

            sidebarToggle.addEventListener('click', function(e) {
                e.preventDefault();
                // Si AdminLTE ne gère pas le toggle, on le fait manuellement
                if (body.classList.contains('sidebar-open')) {
                    body.classList.remove('sidebar-open');
                    body.classList.add('sidebar-collapse');
                } else {
                    body.classList.remove('sidebar-collapse');
                    body.classList.add('sidebar-open');
                }
            });

            // Gestion de la barre de recherche
            const searchToggle = document.getElementById('search-toggle');
            const searchContainer = document.querySelector('.search-container');
            const searchInput = document.getElementById('navbar-search');
            const searchForm = document.getElementById('navbar-search-form');
            const suggestionsList = document.getElementById('search-suggestions');

            searchToggle.addEventListener('click', function(e) {
                e.preventDefault();
                searchContainer.classList.toggle('active');
                if (searchContainer.classList.contains('active')) {
                    searchInput.focus();
                }
            });

            document.addEventListener('click', function(e) {
                if (!searchForm.contains(e.target)) {
                    searchContainer.classList.remove('active');
                    suggestionsList.style.display = 'none';
                }
            });

            // Autocomplétion
            const sidebarLinks = [
                { label: 'TOFE', url: '{% url "dashboard_TOFE" %}', parentDashboard: 'tofe' },
                { label: 'Douanes', url: '{% url "douanes_dashboard" %}', parentDashboard: 'douanes' },
                { label: 'Financements', url: '{% url "financements_dashboard" %}', parentDashboard: 'financements' },
                {% for tableau in tableaux %}
                    { label: '{{ tableau.name|split:": "|slice:"1:"|join:"" }}', tableauId: '{{ tableau.id }}', parentDashboard: 'financements' },
                {% endfor %}
            ];

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                suggestionsList.innerHTML = '';

                if (searchTerm.length < 1) {
                    suggestionsList.style.display = 'none';
                    return;
                }

                const matches = sidebarLinks.filter(item => item.label.toLowerCase().includes(searchTerm));
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const li = document.createElement('li');
                        li.textContent = match.label;
                        li.dataset.tableauId = match.tableauId || '';
                        li.dataset.url = match.url || '';
                        li.dataset.parentDashboard = match.parentDashboard || '';
                        li.addEventListener('click', function() {
                            const tableauId = this.dataset.tableauId;
                            const url = this.dataset.url;
                            const parentDashboard = this.dataset.parentDashboard;

                            if (url && !tableauId) {
                                window.location.href = url;
                            } else if (tableauId && parentDashboard === 'financements') {
                                const targetUrl = '{% url "financements_dashboard" %}';
                                window.location.href = `${targetUrl}?tableau_id=${tableauId}`;
                            }
                            suggestionsList.style.display = 'none';
                            searchInput.value = match.label;
                        });
                        suggestionsList.appendChild(li);
                    });
                    suggestionsList.style.display = 'block';
                } else {
                    suggestionsList.style.display = 'none';
                }
            });

            // Gestion des modales (inchangée)
            function resetModal() {
                document.getElementById('choiceStep').style.display = 'block';
                document.getElementById('userTypeStep1').style.display = 'none';
                document.getElementById('userTypeStep2').style.display = 'none';
            }

            document.getElementById('newAccountBtn').onclick = function() {
                document.getElementById('choiceStep').style.display = 'none';
                document.getElementById('userTypeStep1').style.display = 'block';
            };

            document.getElementById('existingAccountBtn').onclick = function() {
                document.getElementById('choiceStep').style.display = 'none';
                document.getElementById('userTypeStep2').style.display = 'block';
            };

            document.getElementById('backToChoiceStep1').onclick = function() {
                document.getElementById('userTypeStep1').style.display = 'none';
                document.getElementById('choiceStep').style.display = 'block';
            };

            document.getElementById('backToChoiceStep2').onclick = function() {
                document.getElementById('userTypeStep2').style.display = 'none';
                document.getElementById('choiceStep').style.display = 'block';
            };

            document.getElementById('membreBtn1').onclick = function() {
                window.location.href = "{% url 'inscription_membre' %}";
            };

            document.getElementById('visiteurBtn1').onclick = function() {
                window.location.href = "{% url 'inscription_visiteur' %}";
            };

            document.getElementById('membreBtn2').onclick = function() {
                window.location.href = "{% url 'connexion_membre' %}";
            };

            document.getElementById('visiteurBtn2').onclick = function() {
                window.location.href = "{% url 'connexion_visiteur' %}";
            };

            var loginModal = document.getElementById('loginModal');
            loginModal.addEventListener('shown.bs.modal', function() {
                resetModal();
            });
        </script>
    </div>
</body>
</html>